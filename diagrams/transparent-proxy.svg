<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="406px" preserveAspectRatio="none" style="width:1825px;height:406px;" version="1.1" viewBox="0 0 1825 406" width="1825px" zoomAndPan="magnify"><defs><filter height="300%" id="fgrt9rmgzpnkl" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><!--MD5=[29fc43d0dbd8c9ade01292c16c58997f]
cluster tls-proxy - Transparent-Proxy--><rect fill="#FFFFFF" filter="url(#fgrt9rmgzpnkl)" height="274" style="stroke: #000000; stroke-width: 1.5;" width="1255" x="6" y="6"/><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="241" x="513" y="20.9951">tls-proxy - Transparent-Proxy</text><!--MD5=[1738b10290744196459ddcf1d3ddb48e]
entity it--><rect fill="#FEFECE" filter="url(#fgrt9rmgzpnkl)" height="36.2969" style="stroke: #A80036; stroke-width: 1.5;" width="79" x="22" y="220"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="59" x="32" y="242.9951">iptables</text><!--MD5=[72f941736658486a9447ee9af01ffec8]
entity ss--><ellipse cx="342.5" cy="179" fill="#FEFECE" filter="url(#fgrt9rmgzpnkl)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><polygon fill="#A80036" points="338.5,167,344.5,162,342.5,167,344.5,172,338.5,167" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="67" x="309" y="207.9951">SslServer</text><ellipse cx="694.728" cy="197.0456" fill="#FEFECE" filter="url(#fgrt9rmgzpnkl)" rx="85.728" ry="19.5456" style="stroke: #A80036; stroke-width: 1.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="144" x="622.728" y="201.694">HandleHttpConnect</text><ellipse cx="694.6456" cy="108.0291" fill="#FEFECE" filter="url(#fgrt9rmgzpnkl)" rx="70.6456" ry="16.5291" style="stroke: #A80036; stroke-width: 1.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="108" x="640.6456" y="112.6776">ServerNameCb</text><ellipse cx="1170.1122" cy="108.9224" fill="#FEFECE" filter="url(#fgrt9rmgzpnkl)" rx="75.1122" ry="17.4224" style="stroke: #A80036; stroke-width: 1.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="119" x="1110.6122" y="113.5709">FetchCertificate</text><!--MD5=[7d46d6cd919e02e6168a09ad91eae8b4]
entity u--><ellipse cx="1170" cy="325" fill="#FEFECE" filter="url(#fgrt9rmgzpnkl)" rx="8" ry="8" style="stroke: #A80036; stroke-width: 1.5;"/><path d="M1170,333 L1170,360 M1157,341 L1183,341 M1170,360 L1157,375 M1170,360 L1183,375 " fill="none" filter="url(#fgrt9rmgzpnkl)" style="stroke: #A80036; stroke-width: 1.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="31" x="1154.5" y="393.4951">User</text><!--MD5=[8e565b71783df14e1b944b97098c1584]
entity hs--><polygon fill="#FEFECE" filter="url(#fgrt9rmgzpnkl)" points="1666,96,1676,86,1803,86,1803,122.2969,1793,132.2969,1666,132.2969,1666,96" style="stroke: #000000; stroke-width: 1.5;"/><line style="stroke: #000000; stroke-width: 1.5;" x1="1793" x2="1802" y1="96" y2="87"/><line style="stroke: #000000; stroke-width: 1.5;" x1="1666" x2="1793" y1="96" y2="96"/><line style="stroke: #000000; stroke-width: 1.5;" x1="1793" x2="1793" y1="96" y2="132.2969"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="97" x="1681" y="118.9951">HTTPS Server</text><!--MD5=[806b13846ff7c07a11f4c82bab5cbd34]
link u to it--><path d="M1154.46,356.3825 C1108.19,357.4899 960.195,360.1831 838,353 C645.2,341.6664 596.909,335.2247 406,306 C297.505,289.391 171.19,262.387 106.156,247.911 " fill="none" id="u-&gt;it" style="stroke: #A80036; stroke-width: 1.0;"/><polygon fill="#A80036" points="101.199,246.806,109.1122,252.6695,106.0791,247.8946,110.854,244.8614,101.199,246.806" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="83" x="437" y="302.0669">1. ClientHello</text><!--MD5=[05a36402df92f8a5bd114cd419835b51]
link it to ss--><path d="M101.001,230.962 C154.438,221.194 250.49,203.636 303.603,193.927 " fill="none" id="it-&gt;ss" style="stroke: #A80036; stroke-width: 1.0;"/><polygon fill="#A80036" points="308.607,193.013,299.034,190.6983,303.6887,193.913,300.474,198.5676,308.607,193.013" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="146" x="132" y="195.0669">2. new TCP connection</text><!--MD5=[4d499f4de59868d92fc9c101691289a1]
link ss to hc--><path d="M369.136,211.001 C379.724,219.346 392.639,227.69 406,232 C486.989,258.123 586.548,234.409 644.726,215.336 " fill="none" id="ss-&gt;hc" style="stroke: #A80036; stroke-width: 1.0;"/><polygon fill="#A80036" points="649.534,213.739,639.7321,212.7788,644.7887,215.3146,642.253,220.3712,649.534,213.739" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="125" x="416" y="228.0669">3. is HTTP connect?</text><!--MD5=[1cb124cf95ba11b3a91de49604a7672d]
link hc to ss--><path d="M609.563,194.602 C536.996,192.528 435.47,189.628 381.213,188.078 " fill="none" id="hc-&gt;ss" style="stroke: #A80036; stroke-width: 1.0;"/><polygon fill="#A80036" points="376.113,187.932,384.9951,192.1875,381.111,188.0748,385.2236,184.1907,376.113,187.932" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="462.5" y="184.0669">4. no</text><!--MD5=[3b0fbcbaefcbd1db13bd60f512f483e5]
link ss to snc--><path d="M376.213,173.183 C385.705,169.518 396.164,165.805 406,163 C480.952,141.623 569.287,126.119 628.068,117.124 " fill="none" id="ss-&gt;snc" style="stroke: #A80036; stroke-width: 1.0;"/><polygon fill="#A80036" points="633.308,116.327,623.809,113.7251,628.3648,117.0785,625.0114,121.6342,633.308,116.327" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="143" x="407" y="126.0669">5. on server_name_cb</text><!--MD5=[4771b72c348ed93523b4982d22f36684]
link snc to ss--><path d="M648.117,95.47 C588.982,81.74 483.946,66.404 406,105 C383.67,116.057 367.145,139.335 356.714,158.273 " fill="none" id="snc-&gt;ss" style="stroke: #A80036; stroke-width: 1.0;"/><polygon fill="#A80036" points="354.193,162.985,361.9655,156.9362,356.5516,158.5763,354.9116,153.1624,354.193,162.985" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="115" x="421" y="77.0669">5.5 use certificate</text><!--MD5=[eda512d1395929f72d562cedd5dbcb5a]
link snc to fc--><path d="M739.997,120.654 C767.888,127.918 804.734,136.311 838,140 C938.274,151.12 965.168,154.562 1065,140 C1084.77,137.117 1106,131.304 1124.1,125.483 " fill="none" id="snc-&gt;fc" style="stroke: #A80036; stroke-width: 1.0;"/><polygon fill="#A80036" points="1129.11,123.843,1119.3147,122.8172,1124.3543,125.3868,1121.7848,130.4264,1129.11,123.843" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="205" x="849" y="136.0669">5.1 fetch certificate from server</text><!--MD5=[81617cba1f91f85053f501b770256e03]
link fc to snc--><path d="M1094.86,108.843 C1006.35,108.656 859.171,108.346 770.35,108.158 " fill="none" id="fc-&gt;snc" style="stroke: #A80036; stroke-width: 1.0;"/><polygon fill="#A80036" points="765.112,108.147,774.1028,112.1676,770.112,108.1584,774.1211,104.1676,765.112,108.147" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="225" x="839" y="104.0669">5.4 clone of https server certificate</text><!--MD5=[7d76c334c0177dd41b13456db5324dc4]
link fc to hs--><path d="M1230.26,119.56 C1262.33,124.744 1302.71,130.421 1339,133 C1443.18,140.404 1469.85,140.792 1574,133 C1602.52,130.866 1633.68,126.614 1660.82,122.274 " fill="none" id="fc-&gt;hs" style="stroke: #A80036; stroke-width: 1.0;"/><polygon fill="#A80036" points="1665.84,121.463,1656.3231,118.9276,1660.9022,122.2491,1657.5808,126.8282,1665.84,121.463" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="91" x="1411" y="129.0669">5.2 ClientHello</text><!--MD5=[eae3112bbf6de62d68ef5c17489da3e3]
link hs to fc--><path d="M1665.89,101.948 C1655.88,101.139 1645.68,100.446 1636,100 C1476.61,92.659 1436.41,93.245 1277,100 C1266.44,100.448 1255.3,101.145 1244.37,101.958 " fill="none" id="hs-&gt;fc" style="stroke: #A80036; stroke-width: 1.0;"/><polygon fill="#A80036" points="1239.37,102.339,1248.6517,105.6329,1244.3551,101.9533,1248.0347,97.6567,1239.37,102.339" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="233" x="1340" y="91.0669">5.3 ServerHello, ServerCertificate, ...</text><!--MD5=[726ee5258f7fccadb765496f86f97ef9]
link ss to u--><path d="M360.402,211.004 C371.65,225.043 387.695,241.771 406,251 C474.682,285.63 1036.31,342.8347 1149.26,354.0563 " fill="none" id="ss-&gt;u" style="stroke: #A80036; stroke-width: 1.0;"/><polygon fill="#A80036" points="1154.29,354.5556,1145.7351,349.6758,1149.3151,354.0557,1144.9352,357.6357,1154.29,354.5556" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="225" x="582" y="283.0669">6. ServerHello, ServerCertificate, ...</text><!--MD5=[a6b01b41f53c769d80d37b02bc2ff4b3]
@startuml
left to right direction
actor "User" as u
rectangle "tls-proxy - Transparent-Proxy" {
  agent "iptables" as it
  control "SslServer" as ss
  usecase "HandleHttpConnect" as hc
  usecase "ServerNameCb" as snc
  usecase "FetchCertificate" as fc
}

node "HTTPS Server" as hs

u - - -> it : 1. ClientHello
it - -> ss : 2. new TCP connection
ss - -> hc : 3. is HTTP connect?
hc - -> ss : 4. no
ss - -> snc : 5. on server_name_cb
snc - -> fc : 5.1 fetch certificate from server
fc - - - -> hs : 5.2 ClientHello
hs - - - -> fc : 5.3 ServerHello, ServerCertificate, ...
fc - -> snc : 5.4 clone of https server certificate
snc - -> ss : 5.5 use certificate
ss - - -> u : 6. ServerHello, ServerCertificate, ...
@enduml

PlantUML version 1.2020.12(Sat Jun 06 10:54:15 UTC 2020)
(GPL source distribution)
Java Runtime: Java(TM) SE Runtime Environment
JVM: Java HotSpot(TM) 64-Bit Server VM
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>